---
title: "NBA Shot Project"
author: "Chris Williams"
date: "August 20, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE}
```

```{r package}
library(tidyverse)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r read_data}
shots <- read_csv("nba_shots.csv")
player_names <- map_chr(shots$player_name, str_to_title)
shots$player_name <- player_names
# wait on this shots <- shots %>% mutate_if(is.character, as.factor)
str(shots)
shots_nested <- shots %>% group_by(GAME_ID) %>% nest()
totals <- read_csv("totals_1415.csv")
into_names <- names(totals) %>% str_split(",") %>% .[[1]]
names(totals) <- "x"
totals <- totals %>% separate(x, into_names, sep = ",")
totals <- as_data_frame(totals)
head(totals)
positions <- totals %>% select(c("Player", "Pos"))
head(positions)
## checking for missing values and get a sense of what is going on with the data including
## some exploratory analysis and visualization but also want to join with positions so 
## that the nearest defender length/size can be included
```

```{r explore_data}
library(lubridate)
nrow(positions)
n_distinct(positions$Player)
n_distinct(positions$Pos)
positions <- positions %>% distinct(Player, .keep_all = TRUE)
sum(is.na(positions$Player))
positions[which(is.na(positions$Player)),]
positions <- positions %>% drop_na() %>% mutate(rid = row_number())
##this was just a reference line of where the data came from in the totals df
unique(unlist(str_split(positions$Player, "")))
positions$Player <- str_replace_all(positions$Player, "\\\\.*", "")
bad_char <- positions[str_which(positions$Player, "[\\?\uFFFD]"),]
#qmark_player <- positions[str_which(positions$Player, "\\?"),]
#qmark_which <- str_which(positions$Player, "\\?")
#positions$Player <- str_replace_all(positions$Player, "\\?", "")
positions$Player <- if_else(str_detect(positions$Player, "\\?$"), str_replace(positions$Player, "\\?$", "c"), positions$Player)
#bad_char_which <- str_which(positions$Player, "[\\?\uFFFD]")
bad_char_remain <- positions[str_which(positions$Player, "[\\?\uFFFD]"),]
fixed_pname <- c("Alexis Ajinca", "Omer Asik", "Jose Calderon", "Francisco Garcia", "Manu Ginobili", "Jorge Gutierrez", "Nene Hilario", "Ersan Ilyasova", "Donatas Motiejunas", "Damjan Rudez", "Dennis Schroder", "Kevin Seraphin", "Hedo Turkoglu", "Jonas Valanciunas", "Anderson Varejao", "Greivis Vasquez", "Nikola Vucevic")
positions$Player <- plyr::mapvalues(positions$Player, from = bad_char_remain$Player, to = fixed_pname)
#ufffd_player <- positions[str_which(positions$Player, "\uFFFD"), ]
#ufffd_which <- str_which(positions$Player, "\uFFFD")
#positions$Player <- str_replace_all(positions$Player, "\uFFFD", "")
unique(unlist(str_split(positions$Player, "")))
View(positions)
mult_pos <- positions[str_which(positions$Pos, "[^A-Z]"),]
mult_pos1 <- positions[str_which(positions$Pos, ".{3,}"),]
positions$Pos <- str_replace_all(positions$Pos, "^(..)-(..)$", "\\1")
#although position does not guarentee height the further from the positions should represent "mismatch" scenarios, was unable to find player height in a useable format.
#end note = go back and examine players with missing and/or incorrect characters to fix their names
shots %>% group_by(player_name) %>% nest() %>% n_distinct(.$player_name)
player_list <- shots %>% group_by(player_name) %>% summarize(cnt = sum(FGM))
positions <- rename(positions, "player_name" = "Player")
View(positions)
no_match_shots <- shots %>% group_by(player_name) %>% nest() %>% anti_join(positions, by = "player_name") %>% select(player_name)
no_match_pos <- positions %>% anti_join(shots, by = "player_name") %>% select(player_name)
fixed_pname_2 <- c("Joe Ingles", "DeMarre Carroll", "Jimmer Fredette", "Monta Ellis", "J.J. Barea", "Al-Farouq Aminu", "Dirk Nowitzki", "Kyle O'Quinn", "LeBron James", "C.J. Watson", "C.J. Miles", "Danilo Gallinari", "J.J. Hickson", "P.J. Tucker", "Nerlens Noel", "K.J. McDaniels", "JaKarr Sampson", "Luc Mbah a Moute", "O.J. Mayo", "Beno Udrih", "Amar'e Stoudemire", "Tim Hardaway", "D.J. Augustin", "Dwyane Wade", "Ray McCallum", "Ben McLemore", "DeMarcus Cousins", "Steven Adams", "J.J. Redick", "DeAndre Jordan", "CJ McCollum", "LaMarcus Aldridge", "Allen Crabbe", "Zach LaVine")
shots$player_name <- plyr::mapvalues(shots$player_name, from = no_match_shots$player_name, to = fixed_pname_2)
#check the success of the join
shots %>% group_by(player_name) %>% nest() %>% anti_join(positions, by = "player_name") %>% select(player_name)
shots %>% group_by(player_name) %>% nest() %>% semi_join(positions, by = "player_name") %>% n_distinct(.$player_name)
#check some data quality starting with
shots_ranges <- map(shots, ~range(.))
shots %>% filter(PTS_TYPE == 3 & SHOT_DIST < 21.5)
#shots <- shots %>% filter(!(PTS_TYPE == 3 & SHOT_DIST < 21.5)) or just recode them to twos
shots_na <- map(shots, ~sum(is.na(.))) %>% unlist()
#persumably these are situations in which the shot clock is off and game clock seems to be within quarter
shots_ranges$GAME_CLOCK
shots %>% mutate(game_time = (seconds(GAME_CLOCK)/60)) %>% filter(game_time > 24 & is.na(SHOT_CLOCK))
#clearly many instances in which shot clock data is missing
#shots <- shots %>% filter(!(game_time > 24 & is.na(SHOT_CLOCK)))
shots_ranges$TOUCH_TIME
shots %>% filter(TOUCH_TIME <= 0)
shots %>% filter(TOUCH_TIME < 0)
shots %>% filter(TOUCH_TIME == 0 & DRIBBLES > 0)
shots %>% filter(TOUCH_TIME <= 0 & DRIBBLES > 0)
shots %>% filter(TOUCH_TIME > 0) %>% group_by(DRIBBLES) %>% summarize(ave_tt = mean(TOUCH_TIME), sd_tt = sd(TOUCH_TIME), cnt = n()) %>% filter(cnt > 40)
#knn imputation would be
#library(VIM)
#shots$TOUCH_TIME[shots$TOUCH_TIME <= 0 & shots$DRIBBLES > 0] <- NA
#shots <- kNN(shots, variable = "TOUCH_TIME") but this does not take care of the large number of 0s
#touch time should never be negative and the 3000 or so 0s is concerning
#could also used the means like in the line above, but knn produces consistently lower values and sd tends to be greater than 1 but around 1.15-1.35 for each dribble
#
summary(shots)
#drop shots that aren't "realistic"
shots %>% count(SHOT_DIST > 40)
shots %>% count(SHOT_DIST == 0)
#JUST DROP shot dist that equall 0
#shots <- shots %>% filter(SHOT_DIST < 40)
#
#fix defender names
coms <- str_which(shots$CLOSEST_DEFENDER, ",")
all <- row_number(shots$CLOSEST_DEFENDER)
no_coms <- setdiff(all, coms)
unique(shots[no_coms, 15])
shots$CLOSEST_DEFENDER <- str_replace(shots$CLOSEST_DEFENDER, "Nene", "Hilario, Nene")
defend <- str_split(shots$CLOSEST_DEFENDER, ", ")
  nms <- c("last_name", "first_name")
  defenddf <- data_frame(map_chr(defend, 1),
                       map_chr(defend, 2)) %>%
    setNames(nms) %>%
    mutate(player_name = str_c(first_name, last_name, sep = " "))
  anti_join(defenddf, positions, by = "player_name") %>% distinct(player_name)
  ###drop atila dos santos shots - no proof he played
no_match_defenders <- anti_join(defenddf, positions, by = "player_name") %>% distinct(player_name) %>% filter(player_name != "Atila Dos Santos")
fixed_pname_def <- c("J.J. Barea", "C.J. Miles", "C.J. Watson", "J.J. Hickson", "Tim Hardaway", "J.J. Redick", "P.J. Tucker", "K.J. McDaniels", "C.J. Wilcox", "P.J. Hairston", "Jeffery Taylor", "Luigi Datome", "Chuck Hayes", "Glen Rice", "T.J. Warren", "Toure' Murry")
defenddf$player_name<- plyr::mapvalues(defenddf$player_name, from = no_match_defenders$player_name, to = fixed_pname_def)
shots <- shots %>% filter(CLOSEST_DEFENDER != "Dos Santos, Atila")
defend1 <- str_split(shots$CLOSEST_DEFENDER, ", ")
shots <- shots %>% mutate(last_name = map_chr(defend1, 1), first_name = map_chr(defend1, 2))
shots$CLOSEST_DEFENDER <- str_c(shots$first_name, shots$last_name, sep = " ")
#####now join positions to defender names
#def_name <- shots %>% group_by(CLOSEST_DEFENDER) %>% nest() %>% select(CLOSEST_DEFENDER)
#def_id_name <- shots %>% group_by(CLOSEST_DEFENDER, CLOSEST_DEFENDER_PLAYER_ID) %>% nest() %>% select(CLOSEST_DEFENDER, CLOSEST_DEFENDER_PLAYER_ID) 
#def_id_name$CLOSEST_DEFENDER[duplicated(def_id_name$CLOSEST_DEFENDER)]
#quincy pondexterhas two assigned ids
#off_name <- shots %>% group_by(player_name) %>% nest() %>% select(player_name)
##off_id_name <- shots %>% group_by(player_name, player_id) %>% nest() %>% select(player_name, player_id)
###off_id_name$player_name[duplicated(off_id_name$player_name)]
####sum(duplicated(off_id_name$player_name))
shots_nest_player <- shots %>% group_by(player_name) %>% nest() %>% left_join(positions, by = "player_name")
#recoded the names without a match then ensured that the join was successful, shots is now nested
```
#some exploratory visualizations and alterations
```{r exploratory visualizations}
library(cowplot)
index1 <- map_lgl(shots, is.numeric)
names12 <- names(shots[, index1])
plot_lst <- list()
for(i in names12){
  plt <- ggplot(shots, aes_string(x=i)) +
    geom_histogram()
  plot_lst[[i]] <- plt
}
cowplot::plot_grid(plotlist = plot_lst, nrow = 4)
map(plot_lst, print)
#most games are close with bimodal around 0, some "step" patter in number of shots, very few overtime games, relatively normal distr of shot clock with many at 24 (likely off rebounds), most dribbles under 5 short touch time, shots seem to match "modern" nba with most either close or far with relatively few midrange, doesn't seem to be data error in reporting pts type (at least in putting a number other than 2 or 3), most shots occur with a defender with 5 or so feet, fgm is either 1 or 0
colnames(shots[, !index1])
```
